<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>高并发优化方案 - Itlaohuo</title><meta name=Description content="Itlaohuo的博客"><meta property="og:title" content="高并发优化方案"><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:url" content="http://example.org/high-concurrency-solution/"><meta property="og:image" content="http://example.org/img/Kubenetes.assets/image-20200404094800622.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-23T16:24:26+08:00"><meta property="article:modified_time" content="2023-08-23T16:24:26+08:00"><meta property="og:site_name" content="Itlaohuo的博客"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://example.org/img/Kubenetes.assets/image-20200404094800622.png"><meta name=twitter:title content="高并发优化方案"><meta name=twitter:description content><meta name=application-name content="Itlaohuo的博客"><meta name=apple-mobile-web-app-title content="Itlaohuo的博客"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://example.org/high-concurrency-solution/><link rel=prev href=http://example.org/zookeeper-cluster-demo/><link rel=next href=http://example.org/huho-blog/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"高并发优化方案","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/example.org\/high-concurrency-solution\/"},"genre":"posts","keywords":"架构, 优化","wordcount":12192,"url":"http:\/\/example.org\/high-concurrency-solution\/","datePublished":"2023-08-23T16:24:26+08:00","dateModified":"2023-08-23T16:24:26+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"itlaohuo"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=Itlaohuo>Itlaohuo</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=Itlaohuo>Itlaohuo</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">高并发优化方案</h1><h2 class=single-subtitle>High Concurrency Solution</h2><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>itlaohuo</a></span>&nbsp;<span class=post-category>included in <a href=/categories/%E6%8A%80%E6%9C%AF/><i class="far fa-folder fa-fw" aria-hidden=true></i>技术</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-08-23>2023-08-23</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;12192 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;25 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#1高并发优化方案>1高并发优化方案</a><ul><li><a href=#11-分布式事务和锁>1.1 分布式事务和锁</a><ul><li><a href=#111-优化思路>1.1.1 优化思路</a></li><li><a href=#112-详细优化点>1.1.2 详细优化点</a><ul><li><a href=#1121-订货流程去掉分布式锁>1.1.2.1 订货流程去掉分布式锁</a></li><li><a href=#1122-出入库去掉分布式锁>1.1.2.2 出入库去掉分布式锁</a></li><li><a href=#1123-零售商退货去掉分布式事务控制>1.1.2.3 零售商退货去掉分布式事务控制</a></li><li><a href=#1124-零售商换货去掉分布式事务控制>1.1.2.4 零售商换货去掉分布式事务控制</a></li></ul></li></ul></li><li><a href=#12-业务代码优化>1.2 业务代码优化</a><ul><li><a href=#121-优化思路>1.2.1 优化思路</a></li><li><a href=#122-详细优化点>1.2.2 详细优化点</a><ul><li><a href=#1221-库存设计扣减优化>1.2.2.1 库存设计&扣减优化</a></li><li><a href=#1222-订货流程代码优化>1.2.2.2 订货流程代码优化</a></li><li><a href=#1223-调拨流程代码优化>1.2.2.3 调拨流程代码优化</a></li><li><a href=#1224-余额冻结扣款代码优化>1.2.2.4 余额冻结/扣款代码优化</a></li><li><a href=#1225-报表主数据查询>1.2.2.5 报表&主数据查询</a></li></ul></li></ul></li><li><a href=#13-异常补偿机制>1.3 异常补偿机制</a></li><li><a href=#14-业务流水日志>1.4 业务流水日志</a></li><li><a href=#15-权限优化>1.5 权限优化</a></li></ul></li><li><a href=#2-业务架构优化方案>2 业务架构优化方案</a><ul><li><a href=#21-库存能力中心>2.1 库存能力中心</a><ul><li><a href=#211-库存业务模型>2.1.1 库存业务模型</a></li><li><a href=#212-库存扣减模式与状态变化>2.1.2 库存扣减模式与状态变化</a></li><li><a href=#213-库存类型设计>2.1.3 库存类型设计</a><ul><li><a href=#2131-区域销售>2.1.3.1 区域销售</a></li><li><a href=#2132-共享库存>2.1.3.2 共享库存</a></li><li><a href=#214-渠道库存>2.1.4 渠道库存</a></li></ul></li><li><a href=#214-库存查询领域模型>2.1.4 库存查询领域模型</a></li><li><a href=#215-库存数据存储结构参考>2.1.5 库存数据存储结构参考</a><ul><li><a href=#2151-sku库存>2.1.5.1 SKU库存</a></li><li><a href=#2152-仓库存>2.1.5.2 仓库存</a></li><li><a href=#2152-渠道库存>2.1.5.2 渠道库存</a></li></ul></li><li><a href=#216-库存策略营销策略>2.1.6 库存策略&营销策略</a></li></ul></li><li><a href=#22-交易能力中心>2.2 交易能力中心</a><ul><li><a href=#221-交易能单据模型>2.2.1 交易能单据模型</a></li><li><a href=#222-单据个性化>2.2.2 单据个性化：</a></li><li><a href=#223-单据状态流转>2.2.3 单据状态流转：</a></li><li><a href=#224-单据存储方案>2.2.4 单据存储方案</a><ul><li><a href=#2241-canal--es-方案>2.2.4.1 Canal + ES 方案</a></li></ul></li></ul></li><li><a href=#23-调度能力中心>2.3 调度能力中心</a><ul><li><a href=#231-单据状态推进>2.3.1 单据状态推进</a></li><li><a href=#232事件驱动机制方案>2.3.2事件驱动机制方案</a><ul><li><a href=#2321--直接发送>2.3.2.1 直接发送</a></li><li><a href=#2322--事件表>2.3.2.2 事件表</a></li><li><a href=#2323-事务日志>2.3.2.3 事务日志</a></li><li><a href=#2324-总结>2.3.2.4 总结</a></li></ul></li><li><a href=#233-超时控制中心toc>2.3.3 超时控制中心（TOC）</a></li></ul></li></ul></li><li><a href=#3-数据一致性方案>3 数据一致性方案</a><ul><li><a href=#31-订单库存能力对账>3.1 订单&库存能力对账</a><ul><li><a href=#311-库存对账及超卖审计>3.1.1 库存对账及超卖审计</a></li><li><a href=#312-通用业务对账>3.1.2 通用业务对账</a></li></ul></li><li><a href=#32-异常数据监控>3.2 异常数据监控</a></li></ul></li><li><a href=#4-业务架构演进>4 业务架构演进</a><ul><li><a href=#41-应用架构>4.1 应用架构</a></li><li><a href=#42-业务中台>4.2 业务中台</a><ul><li><a href=#421-业务模型图>4.2.1 业务模型图</a></li><li><a href=#422-技术架构图>4.2.2 技术架构图</a></li></ul></li><li><a href=#43-微服务设计暂略去>4.3 微服务设计（暂略去）</a><ul><li><a href=#431-架构模型>4.3.1 架构模型</a></li><li><a href=#432-分层模型>4.3.2 分层模型</a></li><li><a href=#433-依赖解耦>4.3.3 依赖解耦</a></li></ul></li></ul></li><li><a href=#5-其他问题>5 其他问题</a></li><li><a href=#6-参考资料>6 参考资料</a></li></ul></nav></div></div><script>(function(){let e="itlaohuo-9527";e&&prompt("请输入文章密码")!=e&&(alert("密码错误！"),history.length===1?(window.opener=null,window.open("","_self"),window.close()):history.back())})()</script><div class=content id=content><ul><li><a href=#%e5%89%8d%e8%a8%80 rel>前言</a></li><li><a href=#1%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88 rel>1高并发优化方案</a><ul><li><a href=#11-%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1%e5%92%8c%e9%94%81 rel>1.1 分布式事务和锁</a><ul><li><a href=#111-%e4%bc%98%e5%8c%96%e6%80%9d%e8%b7%af rel>1.1.1 优化思路</a></li><li><a href=#112-%e8%af%a6%e7%bb%86%e4%bc%98%e5%8c%96%e7%82%b9 rel>1.1.2 详细优化点</a><ul><li><a href=#1121-%e8%ae%a2%e8%b4%a7%e6%b5%81%e7%a8%8b%e5%8e%bb%e6%8e%89%e5%88%86%e5%b8%83%e5%bc%8f%e9%94%81 rel>1.1.2.1 订货流程去掉分布式锁</a></li><li><a href=#1122-%e5%87%ba%e5%85%a5%e5%ba%93%e5%8e%bb%e6%8e%89%e5%88%86%e5%b8%83%e5%bc%8f%e9%94%81 rel>1.1.2.2 出入库去掉分布式锁</a></li><li><a href=#1123-%e9%9b%b6%e5%94%ae%e5%95%86%e9%80%80%e8%b4%a7%e5%8e%bb%e6%8e%89%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1%e6%8e%a7%e5%88%b6 rel>1.1.2.3 零售商退货去掉分布式事务控制</a></li><li><a href=#1124-%e9%9b%b6%e5%94%ae%e5%95%86%e6%8d%a2%e8%b4%a7%e5%8e%bb%e6%8e%89%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1%e6%8e%a7%e5%88%b6 rel>1.1.2.4 零售商换货去掉分布式事务控制</a></li></ul></li></ul></li><li><a href=#12-%e4%b8%9a%e5%8a%a1%e4%bb%a3%e7%a0%81%e4%bc%98%e5%8c%96 rel>1.2 业务代码优化</a><ul><li><a href=#121-%e4%bc%98%e5%8c%96%e6%80%9d%e8%b7%af rel>1.2.1 优化思路</a></li><li><a href=#122-%e8%af%a6%e7%bb%86%e4%bc%98%e5%8c%96%e7%82%b9 rel>1.2.2 详细优化点</a><ul><li><a href=#1221-%e5%ba%93%e5%ad%98%e8%ae%be%e8%ae%a1%e6%89%a3%e5%87%8f%e4%bc%98%e5%8c%96 rel>1.2.2.1 库存设计&扣减优化</a></li><li><a href=#1222-%e8%ae%a2%e8%b4%a7%e6%b5%81%e7%a8%8b%e4%bb%a3%e7%a0%81%e4%bc%98%e5%8c%96 rel>1.2.2.2 订货流程代码优化</a></li><li><a href=#1223-%e8%b0%83%e6%8b%a8%e6%b5%81%e7%a8%8b%e4%bb%a3%e7%a0%81%e4%bc%98%e5%8c%96 rel>1.2.2.3 调拨流程代码优化</a></li><li><a href=#1224-%e4%bd%99%e9%a2%9d%e5%86%bb%e7%bb%93%e6%89%a3%e6%ac%be%e4%bb%a3%e7%a0%81%e4%bc%98%e5%8c%96 rel>1.2.2.4 余额冻结/扣款代码优化</a></li><li><a href=#1225-%e6%8a%a5%e8%a1%a8%e4%b8%bb%e6%95%b0%e6%8d%ae%e6%9f%a5%e8%af%a2 rel>1.2.2.5 报表&主数据查询</a></li></ul></li></ul></li><li><a href=#13-%e5%bc%82%e5%b8%b8%e8%a1%a5%e5%81%bf%e6%9c%ba%e5%88%b6 rel>1.3 异常补偿机制</a></li><li><a href=#14-%e4%b8%9a%e5%8a%a1%e6%b5%81%e6%b0%b4%e6%97%a5%e5%bf%97 rel>1.4 业务流水日志</a></li><li><a href=#15-%e6%9d%83%e9%99%90%e4%bc%98%e5%8c%96 rel>1.5 权限优化</a></li></ul></li><li><a href=#2-%e4%b8%9a%e5%8a%a1%e6%9e%b6%e6%9e%84%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88 rel>2 业务架构优化方案</a><ul><li><a href=#21-%e5%ba%93%e5%ad%98%e8%83%bd%e5%8a%9b%e4%b8%ad%e5%bf%83 rel>2.1 库存能力中心</a><ul><li><a href=#211-%e5%ba%93%e5%ad%98%e4%b8%9a%e5%8a%a1%e6%a8%a1%e5%9e%8b rel>2.1.1 库存业务模型</a></li><li><a href=#212-%e5%ba%93%e5%ad%98%e6%89%a3%e5%87%8f%e6%a8%a1%e5%bc%8f%e4%b8%8e%e7%8a%b6%e6%80%81%e5%8f%98%e5%8c%96 rel>2.1.2 库存扣减模式与状态变化</a></li><li><a href=#213-%e5%ba%93%e5%ad%98%e7%b1%bb%e5%9e%8b%e8%ae%be%e8%ae%a1 rel>2.1.3 库存类型设计</a><ul><li><a href=#2131-%e5%8c%ba%e5%9f%9f%e9%94%80%e5%94%ae rel>2.1.3.1 区域销售</a></li><li><a href=#2132-%e5%85%b1%e4%ba%ab%e5%ba%93%e5%ad%98 rel>2.1.3.2 共享库存</a></li><li><a href=#214-%e6%b8%a0%e9%81%93%e5%ba%93%e5%ad%98 rel>2.1.4 渠道库存</a></li></ul></li><li><a href=#214-%e5%ba%93%e5%ad%98%e6%9f%a5%e8%af%a2%e9%a2%86%e5%9f%9f%e6%a8%a1%e5%9e%8b rel>2.1.4 库存查询领域模型</a></li><li><a href=#215-%e5%ba%93%e5%ad%98%e6%95%b0%e6%8d%ae%e5%ad%98%e5%82%a8%e7%bb%93%e6%9e%84%e5%8f%82%e8%80%83 rel>2.1.5 库存数据存储结构参考</a><ul><li><a href=#2151-sku%e5%ba%93%e5%ad%98 rel>2.1.5.1 SKU库存</a></li><li><a href=#2152-%e4%bb%93%e5%ba%93%e5%ad%98 rel>2.1.5.2 仓库存</a></li><li><a href=#2152-%e6%b8%a0%e9%81%93%e5%ba%93%e5%ad%98 rel>2.1.5.2 渠道库存</a></li></ul></li><li><a href=#216-%e5%ba%93%e5%ad%98%e7%ad%96%e7%95%a5%e8%90%a5%e9%94%80%e7%ad%96%e7%95%a5 rel>2.1.6 库存策略&营销策略</a></li></ul></li><li><a href=#22-%e4%ba%a4%e6%98%93%e8%83%bd%e5%8a%9b%e4%b8%ad%e5%bf%83 rel>2.2 交易能力中心</a><ul><li><a href=#221-%e4%ba%a4%e6%98%93%e8%83%bd%e5%8d%95%e6%8d%ae%e6%a8%a1%e5%9e%8b rel>2.2.1 交易能单据模型</a></li><li><a href=#222-%e5%8d%95%e6%8d%ae%e4%b8%aa%e6%80%a7%e5%8c%96 rel>2.2.2 单据个性化：</a></li><li><a href=#223-%e5%8d%95%e6%8d%ae%e7%8a%b6%e6%80%81%e6%b5%81%e8%bd%ac rel>2.2.3 单据状态流转：</a></li><li><a href=#224-%e5%8d%95%e6%8d%ae%e5%ad%98%e5%82%a8%e6%96%b9%e6%a1%88 rel>2.2.4 单据存储方案</a><ul><li><a href=#2241-canal--es-%e6%96%b9%e6%a1%88 rel>2.2.4.1 Canal + ES 方案</a></li></ul></li></ul></li><li><a href=#23-%e8%b0%83%e5%ba%a6%e8%83%bd%e5%8a%9b%e4%b8%ad%e5%bf%83 rel>2.3 调度能力中心</a><ul><li><a href=#231-%e5%8d%95%e6%8d%ae%e7%8a%b6%e6%80%81%e6%8e%a8%e8%bf%9b rel>2.3.1 单据状态推进</a></li><li><a href=#232%e4%ba%8b%e4%bb%b6%e9%a9%b1%e5%8a%a8%e6%9c%ba%e5%88%b6%e6%96%b9%e6%a1%88 rel>2.3.2事件驱动机制方案</a><ul><li><a href=#2321--%e7%9b%b4%e6%8e%a5%e5%8f%91%e9%80%81 rel>2.3.2.1 直接发送</a></li><li><a href=#2322--%e4%ba%8b%e4%bb%b6%e8%a1%a8 rel>2.3.2.2 事件表</a></li><li><a href=#2323-%e4%ba%8b%e5%8a%a1%e6%97%a5%e5%bf%97 rel>2.3.2.3 事务日志</a></li><li><a href=#2324-%e6%80%bb%e7%bb%93 rel>2.3.2.4 总结</a></li></ul></li><li><a href=#233-%e8%b6%85%e6%97%b6%e6%8e%a7%e5%88%b6%e4%b8%ad%e5%bf%83toc rel>2.3.3 超时控制中心（TOC）</a></li></ul></li></ul></li><li><a href=#3-%e6%95%b0%e6%8d%ae%e4%b8%80%e8%87%b4%e6%80%a7%e6%96%b9%e6%a1%88 rel>3 数据一致性方案</a><ul><li><a href=#31-%e8%ae%a2%e5%8d%95%e5%ba%93%e5%ad%98%e8%83%bd%e5%8a%9b%e5%af%b9%e8%b4%a6 rel>3.1 订单&库存能力对账</a><ul><li><a href=#311-%e5%ba%93%e5%ad%98%e5%af%b9%e8%b4%a6%e5%8f%8a%e8%b6%85%e5%8d%96%e5%ae%a1%e8%ae%a1 rel>3.1.1 库存对账及超卖审计</a></li><li><a href=#312-%e9%80%9a%e7%94%a8%e4%b8%9a%e5%8a%a1%e5%af%b9%e8%b4%a6 rel>3.1.2 通用业务对账</a></li></ul></li><li><a href=#32-%e5%bc%82%e5%b8%b8%e6%95%b0%e6%8d%ae%e7%9b%91%e6%8e%a7 rel>3.2 异常数据监控</a></li></ul></li><li><a href=#4-%e4%b8%9a%e5%8a%a1%e6%9e%b6%e6%9e%84%e6%bc%94%e8%bf%9b rel>4 业务架构演进</a><ul><li><a href=#41-%e5%ba%94%e7%94%a8%e6%9e%b6%e6%9e%84 rel>4.1 应用架构</a></li><li><a href=#42-%e4%b8%9a%e5%8a%a1%e4%b8%ad%e5%8f%b0 rel>4.2 业务中台</a><ul><li><a href=#421-%e4%b8%9a%e5%8a%a1%e6%a8%a1%e5%9e%8b%e5%9b%be rel>4.2.1 业务模型图</a></li><li><a href=#422-%e6%8a%80%e6%9c%af%e6%9e%b6%e6%9e%84%e5%9b%be rel>4.2.2 技术架构图</a></li></ul></li><li><a href=#43-%e5%be%ae%e6%9c%8d%e5%8a%a1%e8%ae%be%e8%ae%a1%e6%9a%82%e7%95%a5%e5%8e%bb rel>4.3 微服务设计（暂略去）</a><ul><li><a href=#431-%e6%9e%b6%e6%9e%84%e6%a8%a1%e5%9e%8b rel>4.3.1 架构模型</a></li><li><a href=#432-%e5%88%86%e5%b1%82%e6%a8%a1%e5%9e%8b rel>4.3.2 分层模型</a></li><li><a href=#433-%e4%be%9d%e8%b5%96%e8%a7%a3%e8%80%a6 rel>4.3.3 依赖解耦</a></li></ul></li></ul></li><li><a href=#5-%e5%85%b6%e4%bb%96%e9%97%ae%e9%a2%98 rel>5 其他问题</a></li><li><a href=#6-%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99 rel>6 参考资料</a></li></ul><h2 id=前言>前言</h2><ul><li>XXX系统是公司分销系统数字化的重要载体，提高客户下单、门店要货、销量上报、零售退回、盘亏/盘盈、调拨、发货/入库、报表管理等功能。对手机、物料、IOT等产品的库存、销售状态、代理商数字化管理，同事实现精细化生产高效协同、数据透明、共享以及多维度分析，为管理者提高智慧决策。为了更好地实现业务目标，普惠更多的代理和用户，XXX系统逐步在代理商推广开，用户基数越来越大，对系统的性能、可扩展、数据准确性以及稳定性要求越来越高，为了使XXX系统推广能够平稳、顺利的进行，并达到预期的效果，某云团队和公司IT技术团队就XXX应用架构现状做了深入的交流和讨论，设计如下高并发优化方案，供XXX系统后续业务建设参考</li></ul><h2 id=1高并发优化方案>1高并发优化方案</h2><h3 id=11-分布式事务和锁>1.1 分布式事务和锁</h3><ul><li>通过前期调研，XXX分销系统过度依赖分布式事务（大事务）进行控制，导致性能无法达到预期目标，结合公司某部门同事的测试结论<code>&lt;br></code>
优化掉分布式事务和锁后，部分操作异步化&代码优化，核心订货TPS理论等达到100左右，基本能够满足短期内v-vork的业务发展需求。</li></ul><h4 id=111-优化思路>1.1.1 优化思路</h4><ul><li>核心优化思路为尽可能去掉分布式事务&锁控制，考虑在业务模型上采用更有内聚性的设计，将必须要用的部分逻辑（如：流水和扣库存）<code>&lt;/br></code>
抽离出来加本地事务控制，避免在入口处加大段锁控制；详细如下：</li></ul><blockquote><ul><li>1 业务流程分解（权限、订单、扣库存、扣款、出库）；将大事务拆解为小事务，每个小事务内部关注事务内的补偿，<strong>参见代码优化章节</strong>。</li><li>2 库存扣减添加乐观锁，库存表添加version字段，每次更新对比字段，并判断减去当前售卖量库存是否为0，来防止超卖。</li><li>3 拆小锁，合并数据库操作，优先使用本地事务。</li><li>4（工厂版）针对业务层实现的TCC分布式事务，建议完整实现整个流程，在Try阶段进行资源锁定（具体实现上可以在要操作的记录行上用状态位做标识，事务结束前阻止其他线程并发修改），在Confirm和Cancel阶段做实际的提交或回滚。Confirm和Cancel操作做幂等处理。</li><li>尽量减少分布式事务的使用，考虑在业务模型上采用更有内聚性的设计。在可以接受异步的场景下，建议采用Sega模式的设计，利用消息解耦，充分发挥异步的性能优势。在sega设计时注意识别可补偿事务、关键性事务和可重复性事务。对于隔离性问题可采用<code>&lt;b></code>语义锁<code>&lt;b></code>的方式来解决。</li></ul></blockquote><h4 id=112-详细优化点>1.1.2 详细优化点</h4><h5 id=1121-订货流程去掉分布式锁>1.1.2.1 订货流程去掉分布式锁</h5><ul><li><strong>订货下单即支付场景中，涉及到写操作有如下几个部分</strong></li></ul><blockquote><ul><li>a 供货方库存占用insert inventoryOccupy表</li><li>b 占用订货方可拿货金额</li><li>c 回写层级分货DistributionHierarchy，java面向过程的方式计算结果，并发场景会导致数据异常，update set a = a+y 的方式。</li><li>d 插入DistributionHierarchyOccupy记录</li><li>e 订货方库存已订未发 update FreeInventoryQuanity，没有改记录则insert，不在分布式锁控制范围内，但是occupySellerInventory方法添加有锁，该方法存在和C步骤同样的问题，代码计算结果</li><li>f 保存发货计划单</li><li>g 插入订货方金额占用表记录</li><li>h 插入订货方金额流水记录</li><li>i 删除购物车记录</li></ul></blockquote><ul><li><strong>去掉分布式锁的改造点</strong></li></ul><blockquote><ul><li>a 层级分货替换为 update set a= a + y</li><li>b 订货方库存占用替换为 update set a= a + y （高并发环节，加减必须改为自增减）</li><li>c 库存预占时扣减库存，插入库存占用表操作本地事务进行控制</li></ul></blockquote><h5 id=1122-出入库去掉分布式锁>1.1.2.2 出入库去掉分布式锁</h5><ul><li><strong>订货、调拨、出库时涉及的写操作：</strong></li></ul><blockquote><ul><li>a 扣减发货方冻结库存</li><li>b 扣减发货方主库库存（前置到下单时扣减）</li><li>c 更新串码为在途，变更串码归属方为收货方</li><li>d 出库状态更新</li><li>c 生成入库单</li></ul></blockquote><ul><li><strong>去掉分布式锁的改造点</strong></li></ul><blockquote><ul><li>a 冻结库存和扣减发货方主库库存用本地事务进行控制</li><li>b 将不同类型的库存操作抽离出来，针对不同的订单类型封装出库方法</li></ul></blockquote><h5 id=1123-零售商退货去掉分布式事务控制>1.1.2.3 零售商退货去掉分布式事务控制</h5><ul><li>零售退货涉及的写操作：</li></ul><blockquote><ul><li>a 退货销量上报</li><li>b 保存退货单信息</li></ul></blockquote><ul><li>改造点：</li><li>保存退货订单核心函数saveOrUpdate 添加了分布式事务控制，从业务逻辑上看，此处事务控制意义不大，理论上可以去掉</li></ul><h5 id=1124-零售商换货去掉分布式事务控制>1.1.2.4 零售商换货去掉分布式事务控制</h5><ul><li>同 1.1.2.3 零售商退货去掉分布式事务控制</li></ul><h3 id=12-业务代码优化>1.2 业务代码优化</h3><h4 id=121-优化思路>1.2.1 优化思路</h4><ul><li>1 库存扣减加乐观锁，维护可售库存字段</li><li>2 业务逻辑分块，高内聚低耦合</li><li>3 部分高频率读取操作加缓存</li><li>4 容本地事务控制优化部分写操作，确保数据一致性</li></ul><h4 id=122-详细优化点>1.2.2 详细优化点</h4><h5 id=1221-库存设计扣减优化>1.2.2.1 库存设计&扣减优化</h5><ul><li><strong>乐观锁：</strong></li><li>代理版已上线该方案，最终方案中，乐观锁可以被优化掉，直接判断扣减后库存是否小于0</li><li>例子： uddate set a = a +1 ,version = old_version +1 from inventory where account = 1 and version = old_version</li><li><strong>可售字段：</strong></li><li>库存表中维护可售库存字段（避免超卖），inventoryQuantity、freezeInventoryQuantity ，reportQuantity（上报销量）、可售数量、预扣数量、占用数量（预留，主要用于标记出库和极速退货等）</li></ul><h5 id=1222-订货流程代码优化>1.2.2.2 订货流程代码优化</h5><ul><li><strong>代码结构优化</strong></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>订货流程 -&gt; 权限:1 权限校验
</span></span><span class=line><span class=cl>权限 --&gt; 订货流程:
</span></span><span class=line><span class=cl>订货流程 -&gt; 购物车:2 查询购物车
</span></span><span class=line><span class=cl>购物车 --&gt; 订货流程:
</span></span><span class=line><span class=cl>订货流程 -&gt; 库存:3 库存预占
</span></span><span class=line><span class=cl>库存 -&gt; 库存:4 层级分货
</span></span><span class=line><span class=cl>库存 -&gt; 订货流程:
</span></span><span class=line><span class=cl>订货流程 -&gt; 价格:5 价格计算
</span></span><span class=line><span class=cl>价格 --&gt; 订货流程:
</span></span><span class=line><span class=cl>订货流程 -&gt; 支付:6 生成支付订单\n or立即支付
</span></span><span class=line><span class=cl>支付 --&gt; 订货流程:
</span></span><span class=line><span class=cl>订货流程 -&gt; 履约:7 各类单据生成
</span></span><span class=line><span class=cl>履约 --&gt; 订货流程:
</span></span><span class=line><span class=cl>订货流程 -&gt; 购物车:8 删除购物车
</span></span><span class=line><span class=cl>购物车 --&gt; 订货流程:
</span></span></code></pre></td></tr></table></div></div><ul><li>将订货流程代码按照伊桑时序图（权限、购物车、…… 履约）进行重新组织梳理，提高代码的可维护性。</li><li>代码分包的通用原则：</li><li>核心业务流程，独立接口： 比如创建订单，查看订单，退订单，改订单都作为独立接口提供，不打包接口。</li><li>公共实体单独分包： 比如非核心业务流程实体，则可以单独分包，目的时达到公用的，避免重复制定相同接口。</li></ul><h5 id=1223-调拨流程代码优化>1.2.2.3 调拨流程代码优化</h5><ul><li><strong>外部调拨单大致流程：</strong></li><li>1 提交，待审核 2 库存校验 3 串码去重 4 保存调拨数据 5 调出方申请生成发货通知单/出库单 6 冻结库存，此处需要判断冻结库存结果 7 串码状态为冻结 8 非对接wms场景，需要保存到IDC中间表 9 启动工作流</li><li><strong>优化改造点：</strong></li><li>库存占用步骤和冻结串码状态步骤需要判断异常，并进行异常补偿，避免引入脏数据</li><li>库存占用和冻结串码状态步骤用本地事务控制</li></ul><h5 id=1224-余额冻结扣款代码优化>1.2.2.4 余额冻结/扣款代码优化</h5><h5 id=1225-报表主数据查询>1.2.2.5 报表&主数据查询</h5><ul><li><strong>报表查询</strong></li></ul><blockquote><ul><li>a 查询结果添加缓存，减少对数据库直接请求次数</li><li>b 多join查询场景，将中间结果存储到结果表，减少数据库的压力</li><li>c 长期： cannal + ES 进行数据聚合分析查询处理</li><li>d 强烈建议使用SQL生态的BI工具，便于维护，开发效率高，对程序员友好</li></ul></blockquote><ul><li><strong>主数据查询</strong></li></ul><blockquote><ul><li>a globalConfig 等高频查询添加缓存</li></ul></blockquote><h3 id=13-异常补偿机制>1.3 异常补偿机制</h3><ul><li>对订货、退换货、盘盈、盘亏代码流程中增加异常补偿机制和废单逻辑（解决短期的数据一直性问题）；另外，目前代码中对于异常原因状态没有留痕（单据和日志），只是简单的抛出Exception，导致问题排查困难。</li></ul><blockquote><ul><li>A 订单单据中增加order_status 字段，抛出 exception时，需要将状态回写回数据库</li><li>B 增加业务流水日志</li><li>C 异步或者同步对异常单据进行补偿，回补库存你、金额等。</li></ul></blockquote><h3 id=14-业务流水日志>1.4 业务流水日志</h3><ul><li>流水日志是指将业务每一个关键点的详细状态都打印出来&持久化，便于问题的排查和追踪，如在订货过程中：A，B，C，D四个步骤，我们需要在日志中将这四个步骤状态打印出来。这样对于监控线上状态也成为可能，如：</li></ul><blockquote><ul><li>a) 执行步骤A</li><li>b) 打印A的结果信息</li><li>c) 如果程序退出，需要将A的结果持久化到单据状态。</li></ul></blockquote><ul><li>推荐的埋点日志格式：</li></ul><table><tr><th>分类</th><th>埋点字段</th><th>优先级</th><th>描述</th><th>使用</th></tr><tr><td rowspan=4>黄金指标</td><td>场景名称</td><td>必须</td><td>一个SOA服务是一个场景</td><td>GroupBY</td></tr><tr><td>是否成功</td><td>必须</td><td>本次请求在业务上是否成功</td><td>监控数据</td></tr><tr><td>RT</td><td>必须</td><td>本次SOA执行RT</td><td>监控数据</td></tr><tr><td>错误码</td><td>必须</td><td>业务失败唯一识别码</td><td>监控数据</td></tr><tr><td rowspan=3>功能维度</td><td>traceId</td><td>必须</td><td>本次业务请求唯一标识</td><td>监控采样</td></tr><tr><td>压测标</td><td>必须</td><td>是否压测流量</td><td>过滤</td></tr><tr><td>重试次数</td><td>必须</td><td>重试次数</td><td>过滤</td></tr><tr><td rowspan=2>业务信息</td><td>业务身份</td><td>必须</td><td>区分不同的业务身份</td><td>GroupBY</td></tr><tr><td>其他业务信息</td><td>必须</td><td>其他业务信息</td><td>监控采样</td></tr><tr><td rowspan=1>其他</td><td>错误信息</td><td>推荐</td><td>对于错误原因的描述</td><td>监控采样</td></tr></table><ul><li>常见日志埋点技术实现方式，方法维度可以使用spring aop方式自动生成；业务流水日志需要主动埋点打印，强烈建议核心业务流程增加流水日志，提高问题排查效率。</li></ul><h3 id=15-权限优化>1.5 权限优化</h3><ul><li>分销系统的权限较为复杂，涉及到业务系统的各个流程，比较难有通用的解决方案，核心技术关键点在于如何优化和构造权限树；推荐的优化思路：</li><li>1 权限和业务解耦，充分利用缓存，提前预处理优化，提升整体性能；</li><li>2 涉及大量数据查询，统计的功能从主业务流程中剥离，重新组织数据模型，可考虑混合存储模式进行数据持久化，实时性要求高的可引入实时计算平台来解决。</li><li>3 使用高效的数据结构存储+缓存方式</li><li>数据库存储树类型的数据常见的方式：<strong>邻接表、路径枚举、嵌套集、闭包表</strong></li><li>主表（冗余一代，二代，区域等其他必须且改动较小的属性字段）</li><li>高频查询引入redis</li><li>权限变更（大量写），建议在业务低峰操作</li><li>批量数据join查询和分析，使用ES等系统进行旁路，避免阻塞主业务流程</li><li>路径枚举是当前采用的方式，但不便于数据变更和维护，层级也有限</li></ul><h2 id=2-业务架构优化方案>2 业务架构优化方案</h2><h3 id=21-库存能力中心>2.1 库存能力中心</h3><h4 id=211-库存业务模型>2.1.1 库存业务模型</h4><p><img class=lazyload src=/svg/loading.min.svg data-src=/posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88.drawio.png data-srcset="/posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88.drawio.png, /posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88.drawio.png 1.5x, /posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88.drawio.png 2x" data-sizes=auto alt=/posts/architecture/high-concurrency-solution/xxx高并发优化方案.drawio.png title="Alt text"></p><ul><li>交易库存中心，主要负责交易库核心库的查询和写入，同时put库存记录数据到前端缓存系统，所有的交易系统的读库操作都读取缓存数据，提升性能并减少核心库的压力。</li><li>商家接入提供库存修改入口</li><li>库存超时中心则负责对拍下未付款的订单进行释放（库存回补）</li><li>库存任务调度，辅助交易核心库做一些定时或者消息处理的工作，例如：库存释放，关单消息监听回补库存等</li><li>交易库存对账及超卖审计，会通过消息及消息拉取binlog的方式收集库存变更数据和交易订单数据，进行对账和审计，如果需要做到实时对账的功能，可以按需引入流计算平台作为支撑</li><li><strong>说明</strong></li><li>1 核心库存读写分离，读流量前置缓存的模式为后期减少核心库qps压力而设计，前期核心库压力不大的情况，可以暂缓建设。</li><li>2 核心库达到容量瓶颈时，可采用根据商品ID进行分部分表的扩展方案。</li><li>3 课程对账与审计相关：一 库存初始值记录（可以用统计周期开始时间作为初始值） 2 交易订单（含退换货，调拨）与库存变更记录（订货方，供货方）对账。</li></ul><h4 id=212-库存扣减模式与状态变化>2.1.2 库存扣减模式与状态变化</h4><ul><li>库存数量表达： inventory_quantity 可售库存（qu） inventory_occupy 占用库存（oc） free_quantity 冻结(待发、在途) 库存（fr）</li><li>订货模式：订货方（供方出库： fr+, 入库：qu+,fr-）； 供货方（下单：qu-,oc+,支付：oc-,fr+，出库： fr-）</li><li>退换货模式：订货方（下单：qu-,oc+,出库：oc-, fr+，入库 qu+）,供货方（入库 qu+)</li><li>销量上报扣减：qu-</li></ul><h4 id=213-库存类型设计>2.1.3 库存类型设计</h4><p><img class=lazyload src=/svg/loading.min.svg data-src=/posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e5%ba%93%e5%ad%98%e7%b1%bb%e5%9e%8b%e8%ae%be%e8%ae%a1.drawio.png data-srcset="/posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e5%ba%93%e5%ad%98%e7%b1%bb%e5%9e%8b%e8%ae%be%e8%ae%a1.drawio.png, /posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e5%ba%93%e5%ad%98%e7%b1%bb%e5%9e%8b%e8%ae%be%e8%ae%a1.drawio.png 1.5x, /posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e5%ba%93%e5%ad%98%e7%b1%bb%e5%9e%8b%e8%ae%be%e8%ae%a1.drawio.png 2x" data-sizes=auto alt=/posts/architecture/high-concurrency-solution/xxx高并发优化方案-库存类型设计.drawio.png title="Alt text"></p><ul><li>商家销售的商品,消费者可以看到的商品我们称之为前端商品,仓库中的商品为后端商品。</li><li>库存分前端后端商品的模式可以根据业务实际情况进行选择，目前来看以后端商品的模式作为建设重点即可，所以后续将以后的商品库存的模式为主进行讲解。</li></ul><h5 id=2131-区域销售>2.1.3.1 区域销售</h5><ul><li>不同地区有不同的库存，背后是仓库有自己的覆盖范围和库存。从库存中找到覆盖该地区的有库存的仓库，如果有多个仓库，再根据仓库优先级，库存最大值等路由策略的选择一个，然后显示该仓库的库存。</li></ul><h5 id=2132-共享库存>2.1.3.2 共享库存</h5><ul><li>由外部系统保留可共享的仓库存映射关系，在进行库存查询时由商品或商家（订货方、供货方）属性代入特性值，由库存查询系统进行聚合和选择。</li></ul><h5 id=214-渠道库存>2.1.4 渠道库存</h5><ul><li>渠道库存就是专门为渠道预留的，或限制渠道最大可售数量的库存，也可以叫做活动库存，用一个code标识渠道ID。并使用渠道库存的业务需要对商品或交易的特性加入渠道库存标识，称之为渠道库存标识。</li><li>物理库存就是ITEM过程，sku库存，后端商品库存，仓库库存，门店库存的这种有实体对应的库存。</li><li>逻辑库存是一个概念，建造的渠道库存就是逻辑。库存它可以限制在item sku后端，仓库上等它必须和物理库存一起出现。</li><li>渠道库存无法独立存在，所以操作渠道库存的时候，正常情况下渠道库存要和物理库存一起扣减，一起回补。</li><li>渠道库存分类：</li></ul><blockquote><ul><li>1）共享渠道：仅限做渠道，最大可收数量，但不为渠道预留出渠道，所需的库存数量的方式为共享的渠道库存模式。</li><li>2）互斥渠道：既渠道最大可收数量，又为渠道预留出渠道所需的库存数量的方式。</li><li>3）专享渠道：只存在一个渠道，且只能从这个渠道售出的为独享的渠道库存模式。</li></ul></blockquote><ul><li>渠道库存业务应用：</li></ul><blockquote><ul><li>1）营销渠道库存：外部指定（比如优惠系统），支持三个维度（item/SKU/storeCode纬度上挂库存）和物理库存所在的维度可以不同。</li><li>2）商家（经销商、门店）维度渠道库存）：是指商家a可以使用商家b的库存，但是商家b的库存供给多个人，划分出一部分隔商家A专享，商家a可以使用商家b划分出来的商家a专享渠道加共享渠道的库存，为了避免临界点大量失败，如果单渠道满足购买量，优先使用单渠道库存。</li><li>3） 订货方维度渠道库存： 供货方根据下级代理及零售商的多方面因素，划分各下级订货方的专享渠道。订货方可以使用的库存，是专享渠道加共享渠道，要求优先使用专享渠道。</li></ul></blockquote><h4 id=214-库存查询领域模型>2.1.4 库存查询领域模型</h4><ul><li>在库存查询中，按照领域实体和业务范围划分如下3个子域：供货品，仓，库存。</li><li>供货品聚合，聚合根是销售商品。一个销售商品可以对应多个供货品，其他如下图</li><li>供货品子域：解决库存从哪个品出的问题。主要有：自供货，供应链后端供货，共享库存供货模型</li><li>仓子域：解决哪些仓可以供货的问题。主要有2大模型：地址路由（全国覆盖路由，区域销售路由，经纬度路由等）和供给关系路由（货&ndash;货/商&ndash;商/仓&ndash;仓 关系建立的路由模型，商家&ndash;商家&ndash;门店-仓 ， 货品&ndash;货品&ndash;仓&ndash;仓供给关系等模式）</li><li>库存子域：围绕在仓库存、渠道库存等实体展开，最终确定最优的库存结果。在仓库存属于物理库存（现货）</li></ul><p><img class=lazyload src=/svg/loading.min.svg data-src=/posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e5%ba%93%e5%ad%98%e6%9f%a5%e8%af%a2%e9%a2%86%e5%9f%9f%e6%a8%a1%e5%9e%8b.drawio.png data-srcset="/posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e5%ba%93%e5%ad%98%e6%9f%a5%e8%af%a2%e9%a2%86%e5%9f%9f%e6%a8%a1%e5%9e%8b.drawio.png, /posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e5%ba%93%e5%ad%98%e6%9f%a5%e8%af%a2%e9%a2%86%e5%9f%9f%e6%a8%a1%e5%9e%8b.drawio.png 1.5x, /posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e5%ba%93%e5%ad%98%e6%9f%a5%e8%af%a2%e9%a2%86%e5%9f%9f%e6%a8%a1%e5%9e%8b.drawio.png 2x" data-sizes=auto alt=/posts/architecture/high-concurrency-solution/xxx高并发优化方案-库存查询领域模型.drawio.png title="Alt text"></p><h4 id=215-库存数据存储结构参考>2.1.5 库存数据存储结构参考</h4><h5 id=2151-sku库存>2.1.5.1 SKU库存</h5><ul><li>对于同一个商品的库存是树形结构的存储，比如商品1001有若干sku，那么库存记录里面商品ID 1001有一条库存记录，对应的每个sku也有自己的库存记录，且商品item库存等于所有sku的库存总和。</li><li>库存中心要实时维护sku的db库存，缓存，发送SKU的库存变更消息，同事维护item的db库存，缓存，发item库存变更消息</li></ul><h5 id=2152-仓库存>2.1.5.2 仓库存</h5><ul><li>普通后端货品的库存存储是树形结构的存储，具体位2层。根节点是货品总库存数量，叶子节点是货品在每个仓库的库存数量</li><li>db中数据可分为 可售库存、占用库存、冻结库存。</li></ul><table><thead><tr><th>id</th><th>itme_id</th><th>sku_id</th><th>type</th><th>inventory_quantity</th><th>inventory_occupy</th><th>freeze_quantity</th><th>root_id</th><th>parent_id</th><th>dist_id</th></tr></thead><tbody><tr><td>111001</td><td>2001</td><td>0</td><td>0</td><td>1000</td><td>100</td><td>20</td><td>111001</td><td>0</td><td>2001</td></tr><tr><td>111002</td><td>2001</td><td>0</td><td>2</td><td>700</td><td>20</td><td>10</td><td>111001</td><td>111001</td><td>701</td></tr><tr><td>111003</td><td>2001</td><td>0</td><td>2</td><td>300</td><td>80</td><td>10</td><td>111001</td><td>111001</td><td>702</td></tr></tbody></table><ul><li>货品仓 type = 0 ，dist_id为货品id，实仓 type = 2 ，dist_id为仓库storeCode对应的id</li></ul><h5 id=2152-渠道库存>2.1.5.2 渠道库存</h5><ul><li>渠道库存 type = 3,dist_id为渠道Code对应的id</li></ul><table><thead><tr><th>id</th><th>itme_id</th><th>sku_id</th><th>type</th><th>inventory_quantity</th><th>inventory_occupy</th><th>freeze_quantity</th><th>root_id</th><th>parent_id</th><th>dist_id</th></tr></thead><tbody><tr><td>111001</td><td>2001</td><td>0</td><td>0</td><td>1000</td><td>0</td><td>0</td><td>111001</td><td>0</td><td>2001</td></tr><tr><td>111002</td><td>2001</td><td>0</td><td>2</td><td>500</td><td>0</td><td>0</td><td>111001</td><td>111001</td><td>701</td></tr><tr><td>111003</td><td>2001</td><td>0</td><td>2</td><td>500</td><td>0</td><td>0</td><td>111001</td><td>111001</td><td>702</td></tr><tr><td>111004</td><td>2001</td><td>0</td><td>3</td><td>100</td><td>0</td><td>0</td><td>111001</td><td>111001</td><td>801</td></tr><tr><td>111005</td><td>2001</td><td>0</td><td>3</td><td>100</td><td>0</td><td>0</td><td>111001</td><td>111001</td><td>801</td></tr></tbody></table><h4 id=216-库存策略营销策略>2.1.6 库存策略&营销策略</h4><ul><li>库存策略主要解决的是仓路由查询和库存管理的问题，其中仓路由部分的重点是供给关系。路由策略也就是分销层级关系的相关策略逻辑，库存管理部分主要是考虑利用渠道库存来实现层级分伙和指定分销的逻辑，并依次为基础，延展出更多的库存策略实现方案，更灵活的适应未来的业务发展需要。</li></ul><h3 id=22-交易能力中心>2.2 交易能力中心</h3><p><img class=lazyload src=/svg/loading.min.svg data-src=/posts/architecture/high-concurrency-solution/xxx%E9%AB%98%E5%B9%B6%E5%8F%91%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88-%E4%BA%A4%E6%98%93%E4%B8%9A%E5%8A%A1%E6%A8%A1%E5%9E%8B.drawio.png data-srcset="/posts/architecture/high-concurrency-solution/xxx%E9%AB%98%E5%B9%B6%E5%8F%91%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88-%E4%BA%A4%E6%98%93%E4%B8%9A%E5%8A%A1%E6%A8%A1%E5%9E%8B.drawio.png, /posts/architecture/high-concurrency-solution/xxx%E9%AB%98%E5%B9%B6%E5%8F%91%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88-%E4%BA%A4%E6%98%93%E4%B8%9A%E5%8A%A1%E6%A8%A1%E5%9E%8B.drawio.png 1.5x, /posts/architecture/high-concurrency-solution/xxx%E9%AB%98%E5%B9%B6%E5%8F%91%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88-%E4%BA%A4%E6%98%93%E4%B8%9A%E5%8A%A1%E6%A8%A1%E5%9E%8B.drawio.png 2x" data-sizes=auto alt=/posts/architecture/high-concurrency-solution/xxx%E9%AB%98%E5%B9%B6%E5%8F%91%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88-%E4%BA%A4%E6%98%93%E4%B8%9A%E5%8A%A1%E6%A8%A1%E5%9E%8B.drawio.png title="Alt text"></p><h4 id=221-交易能单据模型>2.2.1 交易能单据模型</h4><ul><li>主订单模型与主子订单模型；主子订单模式能够适配多SKU，多优惠，分批发货等不同场景，扩展性强。主子订单模型在order表中增加 is_mian和parent_id 进行区分 ，其他和主订单模式一致。TDOD ： 新增ER图例</li></ul><h4 id=222-单据个性化>2.2.2 单据个性化：</h4><blockquote><ul><li>可预留几个扩展字段（阿里内部预留6个），维护成本低，数据结构化不好（比如直接村json，不利于搜索场景），扩展有限</li><li>个性化场景较为复杂，需要较多字段，可以考虑使用扩展属性表</li></ul></blockquote><h4 id=223-单据状态流转>2.2.3 单据状态流转：</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@startuml
</span></span><span class=line><span class=cl>scale 350 width
</span></span><span class=line><span class=cl>hide empty description
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>state 初始状态: status=-1
</span></span><span class=line><span class=cl>state 待支付 : status=1
</span></span><span class=line><span class=cl>state 待审核 : status=2
</span></span><span class=line><span class=cl>state 待出库 : status=3
</span></span><span class=line><span class=cl>state 待入库 : status=4
</span></span><span class=line><span class=cl>state 支付失败 : status=-2
</span></span><span class=line><span class=cl>state 拒绝 : status=-3
</span></span><span class=line><span class=cl>state 出库失败 : status=-4
</span></span><span class=line><span class=cl>state 入库失败 : status=-5
</span></span><span class=line><span class=cl>state 成功 : status=0
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>[*] --&gt;   初始状态: status=-1
</span></span><span class=line><span class=cl>初始状态 --&gt; 待支付: 成功
</span></span><span class=line><span class=cl>待支付 --&gt; 待审核: 成功
</span></span><span class=line><span class=cl>待支付 --&gt; 支付失败
</span></span><span class=line><span class=cl>待审核 --&gt; 待出库: 成功
</span></span><span class=line><span class=cl>待审核 --&gt; 拒绝
</span></span><span class=line><span class=cl>待出库 --&gt; 待入库: 成功
</span></span><span class=line><span class=cl>待入库 --&gt; 入库失败
</span></span><span class=line><span class=cl>待入库 --&gt; 成功:成功
</span></span><span class=line><span class=cl>成功 --&gt; [*]
</span></span><span class=line><span class=cl>待出库 --&gt; 出库失败
</span></span><span class=line><span class=cl>支付失败 --&gt; [*]
</span></span><span class=line><span class=cl>拒绝 --&gt; [*]
</span></span><span class=line><span class=cl>出库失败 --&gt; [*]
</span></span><span class=line><span class=cl>入库失败 --&gt; [*]
</span></span><span class=line><span class=cl>@enduml
</span></span></code></pre></td></tr></table></div></div><ul><li>对于失败的状态，统一进行数据订正和回补操作，避免脏数据；这样不同类型的订货场景可以通过状态机进行操作的异步解耦，代码逻辑清晰，提升整体性能</li></ul><h4 id=224-单据存储方案>2.2.4 单据存储方案</h4><ul><li>xxx会对单据有一类偏分析类请求（AP请求），AP类型请求对资源消耗可能会很大，一个简单的AP请求可能会小号完系统资源，从而影响现有的TP类线上业务请求，因此需要对TP/AP进行隔离；业界开源方案：引入一个ETL系统将TP数据复制一份给AP使用；商用解决方案：mysql+tablestore</li></ul><h5 id=2241-canal--es-方案>2.2.4.1 Canal + ES 方案</h5><ul><li>为了解决MySQL 在复杂查询场景下的查询性能瓶颈，通常引入ElasticSearch 或 Solr 等搜素引擎作为查询引擎，用作查询加速。问题：用户需要自己维护数同步，保证数据一致性。</li><li>直接监听MySQL的binlog异步写数据到ES，但是会有消费乱序，消费失败，数据不一致等问题。推荐引入Canal开源工具，将数据同步到ES；对于报表强一致性诉求场景可考虑引入rocketMq，通过mq削峰错谷来避免大压力场景下的数据不一致，在adaptor层面对于数据写入失败场景也需要增加补偿，架构图如下：
<img class=lazyload src=/svg/loading.min.svg data-src=/posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e4%ba%a4%e6%98%93%e4%b8%9a%e5%8a%a1-%e5%a4%8d%e6%9d%82%e6%9f%a5%e8%af%a2%e6%96%b9%e6%a1%88.drawio.png data-srcset="/posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e4%ba%a4%e6%98%93%e4%b8%9a%e5%8a%a1-%e5%a4%8d%e6%9d%82%e6%9f%a5%e8%af%a2%e6%96%b9%e6%a1%88.drawio.png, /posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e4%ba%a4%e6%98%93%e4%b8%9a%e5%8a%a1-%e5%a4%8d%e6%9d%82%e6%9f%a5%e8%af%a2%e6%96%b9%e6%a1%88.drawio.png 1.5x, /posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e4%ba%a4%e6%98%93%e4%b8%9a%e5%8a%a1-%e5%a4%8d%e6%9d%82%e6%9f%a5%e8%af%a2%e6%96%b9%e6%a1%88.drawio.png 2x" data-sizes=auto alt=/posts/architecture/high-concurrency-solution/xxx高并发优化方案-交易业务-复杂查询方案.drawio.png title="Alt text"></li><li>单据会持续累积，需要归档，避免MySQL单表数据过大（根据阿里经验不要超过500万），数据归档工具使用pt-archiver工具（开源）。另外单表数据出现瓶颈后，可考虑分库分表，或者在建设之初就进行分库分表设计。</li><li>大批量写场景（代理权限变更等），可以在业务低峰进行（推荐）。或可考虑HBASE开源产品或商业化商品ADB，TABLESTORE产品。</li></ul><h3 id=23-调度能力中心>2.3 调度能力中心</h3><ul><li>包含两部分：单据状态推进能力，超时控制中心（TOC）</li></ul><h4 id=231-单据状态推进>2.3.1 单据状态推进</h4><ul><li>基于事件的单据状态推进的方式，能够对单据核心逻辑进行异步解耦，各个步骤之间不依赖，又提升整体性能，提升个模块代码的维护效率。</li><li>单据状态：下单、审核、支付、出库、入库。
<img class=lazyload src=/svg/loading.min.svg data-src=/posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e8%b0%83%e5%ba%a6-%e5%8d%95%e6%8d%ae%e7%8a%b6%e6%80%81%e6%b5%81%e7%a8%8b.drawio.png data-srcset="/posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e8%b0%83%e5%ba%a6-%e5%8d%95%e6%8d%ae%e7%8a%b6%e6%80%81%e6%b5%81%e7%a8%8b.drawio.png, /posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e8%b0%83%e5%ba%a6-%e5%8d%95%e6%8d%ae%e7%8a%b6%e6%80%81%e6%b5%81%e7%a8%8b.drawio.png 1.5x, /posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e8%b0%83%e5%ba%a6-%e5%8d%95%e6%8d%ae%e7%8a%b6%e6%80%81%e6%b5%81%e7%a8%8b.drawio.png 2x" data-sizes=auto alt=/posts/architecture/high-concurrency-solution/xxx高并发优化方案-调度-单据状态流程.drawio.png title="Alt text"></li><li>调度中心订阅消息推进单据后续步骤运行</li><li>失败/废单：根据创建失败、支付失败 …… 进行单据状态和数据回补</li><li>对账，超时控制（超时则发送超时消息，调度中心调用废单模块进行数据回补），后门管理模块（用于补发单据状态信息，另外会定时扫描当前为结束顶顶那是否存在异常或状态丢失情况，如有异常则进行订正和告警通知）</li></ul><h4 id=232事件驱动机制方案>2.3.2事件驱动机制方案</h4><ul><li>有三种方案实现：</li></ul><h5 id=2321--直接发送>2.3.2.1 直接发送</h5><ul><li>业务数据创建或更新后，业务系统发送消息，消息体包含事件内容和状态。</li><li>如何保证数据库与消息队列之间的数据一致性</li></ul><blockquote><ul><li>最大努力通知：系统重试机制，和定时单据状态扫描回补机制，避免系统异常导致消息状态丢失，订单无法推进。</li><li>事务消息： RocketMq事务消息，使用方式是在数据库事务之前先向MQ的Broker 发送一条prepare消息，在数据库事务之后再commit消息。如果再数据库事务之后没有commit，RocketMQ Broker会定期回调，业务系统提供回调接口，用来判断数据一致性。</li></ul></blockquote><h5 id=2322--事件表>2.3.2.2 事件表</h5><ul><li>核心思想是利用本地事务完成业务数据更新和事件发布的一致性，具体实现如下：</li><li>使用一个与订单表位于同一个数据库的事件记录表记录事件数据，利用本地数据库事务保障数据一致性。订单服务在一个事务内完成订单创建或更新操作和事件创建操作后，操作即完成，<strong>不直接操作消息队列</strong>。 事件引擎轮询事件表，发现新事件后，将事件发布到消息队列后更新事件表中的事件状态，从而完成整个业务数据更新和事件发布的流程，并保证数据一致性。</li><li>优点：事件表将一部分时间发布动作和保证数据一致性的功能从业务系统转移到一个专门的事件引擎服务。从而降低了业务服务的复杂性，提升了业务服务的稳定性。</li><li>缺点：需要额外研发事件引擎和设计额外的事件表，除了需要实现正常事件发布功能外，还需要实现历史事件归档或清理的逻辑。事件发布时效性取决于轮询频次，与直接发送方式相比，实时性会有所降低。</li></ul><h5 id=2323-事务日志>2.3.2.3 事务日志</h5><ul><li>同上一种方法事件表一样，事务日志也是利用数据库本地事务保证业务数据和事件数据一致性的设计。不同点在于事务日志方法时将数据库事务日志（如 MySQL的binlog）作为事件表的来源。</li><li>在具体实现时，可使用开源组件如阿里开源的canal接收事务；该方案相对于事件表方式而言提升了时效性，但是整体实现方案较复杂，适合大规模海量并发场景。</li></ul><h5 id=2324-总结>2.3.2.4 总结</h5><p>结合xxx系统单据量来看，相对较适合方案一：直接发送方式。开发和维护成本小，时效性也高。</p><h4 id=233-超时控制中心toc>2.3.3 超时控制中心（TOC）</h4><ul><li>对于xxx单据系统中，直接单据生成时，如配置有超时扩展点，那么会生成超时任务任务，xxl-job定时扫描超时任务表，将任务表数据存入内存，超时控制中心会订阅支付状态消息，支付成功，则将对应的超时任务失效。</li><li><img class=lazyload src=/svg/loading.min.svg data-src=/posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e8%b6%85%e6%97%b6%e6%8e%a7%e5%88%b6%e4%b8%ad%e5%bf%83.drawio.png data-srcset="/posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e8%b6%85%e6%97%b6%e6%8e%a7%e5%88%b6%e4%b8%ad%e5%bf%83.drawio.png, /posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e8%b6%85%e6%97%b6%e6%8e%a7%e5%88%b6%e4%b8%ad%e5%bf%83.drawio.png 1.5x, /posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e8%b6%85%e6%97%b6%e6%8e%a7%e5%88%b6%e4%b8%ad%e5%bf%83.drawio.png 2x" data-sizes=auto alt=/posts/architecture/high-concurrency-solution/xxx高并发优化方案-超时控制中心.drawio.png title="Alt text"></li></ul><h2 id=3-数据一致性方案>3 数据一致性方案</h2><h3 id=31-订单库存能力对账>3.1 订单&库存能力对账</h3><h4 id=311-库存对账及超卖审计>3.1.1 库存对账及超卖审计</h4><ul><li>库存对账系统结构图
<img class=lazyload src=/svg/loading.min.svg data-src=/posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e5%ba%93%e5%ad%98%e5%af%b9%e8%b4%a6%e7%b3%bb%e7%bb%9f%e7%bb%93%e6%9e%84%e5%9b%be.drawio.png data-srcset="/posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e5%ba%93%e5%ad%98%e5%af%b9%e8%b4%a6%e7%b3%bb%e7%bb%9f%e7%bb%93%e6%9e%84%e5%9b%be.drawio.png, /posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e5%ba%93%e5%ad%98%e5%af%b9%e8%b4%a6%e7%b3%bb%e7%bb%9f%e7%bb%93%e6%9e%84%e5%9b%be.drawio.png 1.5x, /posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e5%ba%93%e5%ad%98%e5%af%b9%e8%b4%a6%e7%b3%bb%e7%bb%9f%e7%bb%93%e6%9e%84%e5%9b%be.drawio.png 2x" data-sizes=auto alt=/posts/architecture/high-concurrency-solution/xxx高并发优化方案-库存对账系统结构图.drawio.png title="Alt text"></li><li>参考实现架构：</li><li>数据源 ：上图左侧都是数据源，库存binlog，交易数据库binlog，左侧最下方为库存变更日志，对账系统分别从上述数据源拉取原始数据。</li></ul><blockquote><ul><li>商品维度超卖审计需要的数据：初始库存、商家调整的库存数量、交易数量、订单关闭返回库存数量</li></ul></blockquote><ul><li>流式计算框架： 核心组件运行在JStorm上的。对账Bolt时最为核心的组件，数据写入MySQL，而商品维度的Bolt和交易统计的Bolt数据写入Hbase.</li><li>复检系统：对账是初步检验，已经发现了部分异常的订单。为了确保万无一失，复检系统会查询其他系统，等到真正异常的订单。</li><li>对账系统核心处理逻辑：
<img class=lazyload src=/svg/loading.min.svg data-src=/posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e5%af%b9%e8%b4%a6%e7%b3%bb%e7%bb%9f%e6%a0%b8%e5%bf%83%e5%a4%84%e7%90%86%e9%80%bb%e8%be%91.drawio.png data-srcset="/posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e5%af%b9%e8%b4%a6%e7%b3%bb%e7%bb%9f%e6%a0%b8%e5%bf%83%e5%a4%84%e7%90%86%e9%80%bb%e8%be%91.drawio.png, /posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e5%af%b9%e8%b4%a6%e7%b3%bb%e7%bb%9f%e6%a0%b8%e5%bf%83%e5%a4%84%e7%90%86%e9%80%bb%e8%be%91.drawio.png 1.5x, /posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e5%af%b9%e8%b4%a6%e7%b3%bb%e7%bb%9f%e6%a0%b8%e5%bf%83%e5%a4%84%e7%90%86%e9%80%bb%e8%be%91.drawio.png 2x" data-sizes=auto alt=/posts/architecture/high-concurrency-solution/xxx高并发优化方案-对账系统核心处理逻辑.drawio.png title="Alt text"></li></ul><h4 id=312-通用业务对账>3.1.2 通用业务对账</h4><p><img class=lazyload src=/svg/loading.min.svg data-src=/posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e9%80%9a%e7%94%a8%e4%b8%9a%e5%8a%a1%e5%af%b9%e8%b4%a6.drawio.png data-srcset="/posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e9%80%9a%e7%94%a8%e4%b8%9a%e5%8a%a1%e5%af%b9%e8%b4%a6.drawio.png, /posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e9%80%9a%e7%94%a8%e4%b8%9a%e5%8a%a1%e5%af%b9%e8%b4%a6.drawio.png 1.5x, /posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e9%80%9a%e7%94%a8%e4%b8%9a%e5%8a%a1%e5%af%b9%e8%b4%a6.drawio.png 2x" data-sizes=auto alt=/posts/architecture/high-concurrency-solution/xxx高并发优化方案-通用业务对账.drawio.png title="Alt text"></p><ul><li>数据源</li></ul><blockquote><ul><li>通过消息实时驱动和binlog同步方式获取源数据</li></ul></blockquote><ul><li>规则脚本 :</li></ul><blockquote><ul><li>通过groovy/java编写校验规则，可以接入分布式服务和缓存等第三方服务</li></ul></blockquote><ul><li>报警与报表：</li></ul><blockquote><ul><li>异常数据产生后，事件可通过邮件、钉钉群、短信等途径报警。详细的执行情况可通过报表展现</li></ul></blockquote><ul><li>对账类型</li></ul><blockquote><ul><li>涉及的商业订单可分为不同场景的对账。</li><li>1 实时对账：可用于解决下单创建订单后交易消息丢失等系统问题，在一定延迟发起订单核对和目标数据进行核验。</li><li>2 定时对账：每日或每周进行定时对账，校验历史订单的状态</li><li>3 数据变动对账：在当前订单数据DB字段发生改变时主动拉取目标数据进行对账，主要用于校验一些状态修改是否合规及准确性。</li></ul></blockquote><ul><li>以上场景可以通过不同的订阅方式进行触发，场景1和2可用消息或binlog进行监听数据的变动，场景3可用binlog消费来触发对账事件。</li></ul><h3 id=32-异常数据监控>3.2 异常数据监控</h3><ul><li>按照<a href=#14-%e4%b8%9a%e5%8a%a1%e6%b5%81%e6%b0%b4%e6%97%a5%e5%bf%97 rel>1.4 业务流水日志</a>章节提到的标准日志埋点后，用Logstash将打印在本地流水日志采集到ElasticSearch进行分析监控展示，第一时间发现系统异常。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@startuml
</span></span><span class=line><span class=cl>:业务流水日志;
</span></span><span class=line><span class=cl>:ELK;
</span></span><span class=line><span class=cl>@enduml
</span></span></code></pre></td></tr></table></div></div><h2 id=4-业务架构演进>4 业务架构演进</h2><h3 id=41-应用架构>4.1 应用架构</h3><ul><li>容器化、OAM方向演进</li></ul><h3 id=42-业务中台>4.2 业务中台</h3><h4 id=421-业务模型图>4.2.1 业务模型图</h4><ul><li>业务分身： 物料、终端零售、IOT，手机分销</li><li>解决方案： 终端零售、通用区域手机分销、海外手机分销、IOT、物料解决方案</li><li>商业能力 交易能力（订货、退换货等）、结算能力（预付款、费用核销等）、分销能力（商品投放、渠道营销等）；商业能力，商业能力扩展点，业务流程，业务活动</li><li>业务域：分销、交易、库存、商品、支付。业务域，业务域服务，业务域服务扩展点</li><li>业务视角</li></ul><blockquote><p>业务身份是对不同的业务方的标识信息，用于界定和区分系统为业务方分配哪些商业能力的依据，针对不同业务方需求进行逻辑隔离的依据。技术视角：通过业务身份对系统的程序逻辑和配置信息进行虚拟分区（APP包），从而使得每个使用系统的业务身份，能使用到一个单独的虚拟实例，并且可以对这个虚拟实例进行定制化。</p></blockquote><ul><li>商业能力</li></ul><blockquote><p>商业能力是为了达到某个特定的商业的目的而提供的一组聚合的业务活动、流程、规则的集合，是实现业务需求的模块化组件，业务方通过快速复用商业能力的方式，保证了快速实现业务需求，提升系统质量。</p></blockquote><ul><li>业务活动</li></ul><blockquote><p>业务活动通常指的是特定角色为了达到某一个特定的目的业务动作的集合，业务活动以信息对象为粒度构成的基础单元，通过业务活动构建商业能力，业务活动比商业能力的粒度更小，因此具有更高的抽象性和稳定性。</p></blockquote><ul><li>业务活动</li></ul><blockquote><p>业务流程是描述商业能力为了达到特定的业务目标，按照一定时序锁执行的各种业务活动的过程。业务流程中描述了各环节的IPO（输入、输出、处理），通过这种方式能够让软件开发过程中的各种角色清晰直观的了解整体业务需求，避免协作过程中理解的不一致。</p></blockquote><ul><li>商业能力扩展点</li></ul><blockquote><p>商业能力扩展点为了实现业务方差异化、灵活性的业务逻辑、规则，同时避免导致系统的复杂性和不稳定，设计的个性化参数配置点。扩展点应用范围包括：属性扩展、流程扩展、业务规则扩展。</p></blockquote><ul><li>业务域</li></ul><blockquote><p>业务域是领域建模过程中，针对目标领域中涉及到所有业务对象及其服务，按照业务对象高内聚、低耦合的原则进行的抽象、归类的一组系统服务，目的是降低耦合性，提高复用性。</p></blockquote><ul><li>系统域服务</li></ul><blockquote><p>系统域服务指各个系统域对外提供可供系统流程编排的服务接口。系统域服务需要对外屏蔽内部的具体实现的依赖关系。例如：库存功能域提供的库存查询服务、外部调用方不需要关心库存你管理的具体是和哪个第三方库存中心绑定的。</p></blockquote><ul><li>系统域服务扩展点</li></ul><blockquote><p>系统域对外提供的可扩展能力，一次系统服务调用的逻辑中，允许第三方进行扩展实现的节点。根据扩展点的粒度不同，可以分为类级和方法级。系统域服务扩展点是对商业能力扩展点的技术实现。</p></blockquote><h4 id=422-技术架构图>4.2.2 技术架构图</h4><p><img class=lazyload src=/svg/loading.min.svg data-src=/posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e6%8a%80%e6%9c%af%e6%9e%b6%e6%9e%84%e5%9b%be.drawio.png data-srcset="/posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e6%8a%80%e6%9c%af%e6%9e%b6%e6%9e%84%e5%9b%be.drawio.png, /posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e6%8a%80%e6%9c%af%e6%9e%b6%e6%9e%84%e5%9b%be.drawio.png 1.5x, /posts/architecture/high-concurrency-solution/xxx%e9%ab%98%e5%b9%b6%e5%8f%91%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88-%e6%8a%80%e6%9c%af%e6%9e%b6%e6%9e%84%e5%9b%be.drawio.png 2x" data-sizes=auto alt=/posts/architecture/high-concurrency-solution/xxx高并发优化方案-技术架构图.drawio.png title="Alt text"></p><ul><li>交易中心：订单、支付、购物车能力</li><li>库存中心：库存生命周期管理，支持各类型的商品库存，如渠道库存等</li><li>营销中心：营销策略中心，如限购、上下限、折扣、满减等</li><li>商品中心：商品品类管理，上下架、区域销售等</li><li>能力中心提供核心愿你在能力，业务按照业务场景进行组合和编排，对外提供服务。</li></ul><h3 id=43-微服务设计暂略去>4.3 微服务设计（暂略去）</h3><h4 id=431-架构模型>4.3.1 架构模型</h4><ul><li>在我们传统的代码里面，我们一般都很注重每个外部依赖的实现细节和规范，但是如果我们抛弃掉原有的理论，重新审视代码结构，抛弃掉具体实现细节，我们会发现每一个对外部的抽象类其实就是输入或输出，类似于计算机系统的I/O节点。这个管对岸在CQRS架构中也同样适用，将所有接口分为Command(输入)和Query（输出）两种。除了I/O之外其他的内部逻辑就是应用的核心逻辑。基于这个基础，架构的组织关系可以变成一个二维的内外关系，而不是传统的一维的上下关系。同时我们可以发现UI层、DB层和各层中间件层实际上没有本质区别的，都只是数据的输入和输出，而不是在传统架构中的最上层和最下层。Hex架构、洋葱架构、干净架构也都是极为类似的思想，整体架构都是基于一个二维的内外关系。</li></ul><h4 id=432-分层模型>4.3.2 分层模型</h4><ul><li>COLA架构（COLA4.0 参考Github链接） (<a href=https://github.com/alibaba/COLA target=_blank rel="noopener noreffer">GitHub - alibaba/COLA: 🥤 COLA: Clean Object-oriented & Layered Architecture</a>)</li></ul><h4 id=433-依赖解耦>4.3.3 依赖解耦</h4><ul><li>防腐层：应用不要直接依赖外域信息，要把外域的信息转换成自己领域上下文的实体再去使用，从而实现本域和外域的解耦。</li></ul><h2 id=5-其他问题>5 其他问题</h2><ul><li><p>1 现在主数据权限在common服务中，在分销业务或报表中匹配权限只能是先从common库查询出来权限列表，然后再拼SQL，如果有些权限较大有上千客户的账号，可能拼接出来长达几千行的SQL，针对这个点有其他更好的方案吗？</p><blockquote><ul><li>长期方案（只针对报表）：查询能力旁路，如：将相关数据同步（canal）到ES，通过ES聚合查询</li></ul></blockquote><blockquote><ul><li>短期方案：java层面对查询进行分批控制，分批查询，查询必须要有分页，避免慢SQL将数据库拖死；如果是前端的直接查询，可以改为服务端增量同步给端侧，降低对数据库的压力。（增量加载）</li></ul></blockquote></li><li><p>2 线上分销（DPS）如果重构，基于我们目前的服务模块，做在哪里更好（包含代理版，工厂版，南京做的几个中心等）</p><blockquote><p>前提 ： DPS 默认都是一代，不会有层级分货等逻辑，不考虑项目周期
纯从技术角度 ： 工厂版合适，如果是DPS业务场景会有层级分货、调拨之类的，且项目周期较短，那估计代理版落地可能会很快，但后续维护时问题（与工厂版整合）</p></blockquote><blockquote><p>工厂版优势：
a . 符合整合趋势（各中心）
b . 代码维护成本相对低（无需关注历史业务逻辑）等同于新开发</p></blockquote><blockquote><p>工厂版劣势：
a . 项目周期可能会比较长，工厂版目前不支持手机分销（库存、单据等）</p></blockquote><blockquote><p>代理版优势：
a . 开发周期会短一些</p></blockquote><blockquote><p>代理版劣势：
a . 不符合将来都整合到工厂版的趋势</p></blockquote><blockquote><p>关键点： 需要参考DPS业务需求，确认是否可以服用到各业务中心的能力</p></blockquote></li><li><p>3 报表，我们想着数据应该落地一个DB，但是针对服务不确定要不要做一个统一的，或者水这个全国性的报表落地到哪块？</p><blockquote><p>建议先按照统一做。手机、IOT、终端的报表数据维度理论都一致，都是抽数到DB，无外乎时多抽了几个数据库的数据。后面万一要过渡到分析型数据库或者SQL生态BI工具，成本也相对低。</p></blockquote></li><li><p>4 VRS 搬迁</p></li><li><p>5 自定义报表</p></li><li><p>6 多时区</p><blockquote><p>推荐方案(落地快，改动小)</p><ul><li>A 统一前端改，包含转换；后端不动（建议后端存储时区，方便排查问题）</li><li>B 需要梳理现有DB中是否有使用DATE说着STRING 表示时间的写法，需要统一订正为DATETIME或者INSTANT表示</li></ul></blockquote><blockquote><p>标准方案（改动量大，短期内难落地）</p><ul><li>后端接口支持多时区，需要将所有对时区敏感结果修改为都市区的接口</li></ul></blockquote></li></ul><h2 id=6-参考资料>6 参考资料</h2><ul><li><a href=https://docs.percona.com/percona-toolkit/pt-archiver.html target=_blank rel="noopener noreffer">pt-archiver 工具2.2文档</a></li></ul></div><script src=https://cdn.jsdelivr.net/gh/jmnote/plantuml-encoder@1.2.4/dist/plantuml-encoder.min.js integrity="sha256-Qsk2KRBCN5qVZX7B+8+2IvQl1Aqc723qV1tBCQaVoqo=" crossorigin=anonymous></script>
<script>(function(){let e="language-";Array.prototype.forEach.call(document.querySelectorAll("[class^="+e+"]"),function(e){if(console.info(e),e.innerText.indexOf("startuml")>0){console.log("is plantuml:"+e.innerText);let t=document.createElement("IMG");t.loading="lazy",t.src="http://www.plantuml.com/plantuml/svg/~1"+plantumlEncoder.encode(e.innerText),e.parentNode.parentNode.insertBefore(t,e.parentNode),e.style.display="none"}else console.log("not plantuml")})})()</script><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-08-23</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=http://example.org/high-concurrency-solution/ data-title=高并发优化方案 data-hashtags=架构,优化><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=http://example.org/high-concurrency-solution/ data-hashtag=架构><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=http://example.org/high-concurrency-solution/ data-title=高并发优化方案><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=http://example.org/high-concurrency-solution/ data-title=高并发优化方案><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=http://example.org/high-concurrency-solution/ data-title=高并发优化方案><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/%E6%9E%B6%E6%9E%84/>架构</a>,&nbsp;<a href=/tags/%E4%BC%98%E5%8C%96/>优化</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/zookeeper-cluster-demo/ class=prev rel=prev title=使用Docker快速搭建ZooKeeper集群><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>使用Docker快速搭建ZooKeeper集群</a>
<a href=/huho-blog/ class=next rel=next title=Hugo搭建博客部分问题记录>Hugo搭建博客部分问题记录<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.114.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2021 - 2025</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Itlaohuo</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>